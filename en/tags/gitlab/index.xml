<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>GitLab - Tag - Dennys Diary</title>
        <link>https://dennys.github.io/en/tags/gitlab/</link>
        <description>GitLab - Tag - Dennys Diary</description>
        <generator>Hugo -- gohugo.io</generator><language>en</language><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Fri, 25 Mar 2022 00:00:00 &#43;0800</lastBuildDate><atom:link href="https://dennys.github.io/en/tags/gitlab/" rel="self" type="application/rss+xml" /><item>
    <title>Use GitLab to do .NET 4.X CI/CD</title>
    <link>https://dennys.github.io/en/doc/devops/gitlab-dotnet4-ci-cd/</link>
    <pubDate>Fri, 25 Mar 2022 00:00:00 &#43;0800</pubDate>
    <author>Dennys</author>
    <guid>https://dennys.github.io/en/doc/devops/gitlab-dotnet4-ci-cd/</guid>
    <description><![CDATA[<h2 id="precondition">Precondition</h2>
<p>You already have a GitLab (<a href="http://gitlab.com/" target="_blank" rel="noopener noreffer">GitLab Saas</a> or GitLab self managed). This document is for .NET 4.X, if you want to build .NET core or .NET 5/6/7/&hellip;, you can use docker to run GitLab Runner.</p>
<h3 id="step-1---install-git-client">Step 1 - Install Git client</h3>
<p>Download and install <a href="https://git-scm.com/download/win" target="_blank" rel="noopener noreffer">Git for Windows</a>. Portable version is ok, but because Git Runner is a Windows service, please add git.exe into PATH.</p>
<h3 id="step-2---prepare-net-build-environment">Step 2 - prepare .NET build environment</h3>
<p>Download and install <a href="https://visualstudio.microsoft.com/" target="_blank" rel="noopener noreffer">Visual Studio</a>. (Please let me know if I can build a .NET build environment without Visual Studio, thanks.)</p>
<h3 id="step-3---install-gitlab-runner">Step 3 - Install GitLab Runner</h3>
<ol>
<li>
<p>Download <a href="https://docs.gitlab.com/runner/install/windows.html" target="_blank" rel="noopener noreffer">GitLab Runner</a></p>
</li>
<li>
<p>Rename <code>gitlab-runner-windows-amd64.exe</code> to <code>gitlab-runner.exe</code></p>
</li>
<li>
<p>Get the token to run GitLab Runner</p>
 
</li>
<li>
<p>Generate GitLab Runner configuration file (config.toml) and run the command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gitlab-runner.exe register --url https://gitlab.com/ --registration-token <span class="nv">$REGISTRATION_TOKEN</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Modify config.toml</p>
<ol>
<li>Because Gitlab Runner doesn&rsquo;t suppoer Windows shell after version 13, you need to use PowerShell. If you use Power Shell, please open config.toml and rename &lsquo;pwsh&rsquo; to &lsquo;powershell&rsquo;. (If you use <a href="https://github.com/PowerShell/PowerShell" target="_blank" rel="noopener noreffer">Power Shell Core</a>, you don&rsquo;t need to do anything)</li>
<li>If you use a portable Git, you need to modify <code>$env:Path</code> of PowerShell.</li>
<li>If you find your log is garbled (ex: your Windows server is not English version), please add <code>chcp 65001</code> to change the encoding to UTF-8.</li>
</ol>
</li>
<li>
<p>Register GitLab Runner as a Windows service and start it.</p>
<ol>
<li>Run the command <code>gitlab-runner install</code> to install as a Windows service.</li>
<li>Run the command <code>gitlab-runner start</code> to start the service.</li>
</ol>
</li>
<li>
<p>config.toml sample =&gt; <em>remember, if you modify the file, please execute <code>gitlab-runner.exe restart</code> to restart GitLab runner.</em></p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="nx">concurrent</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">check_interval</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">session_server</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">session_timeout</span> <span class="p">=</span> <span class="mi">1800</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[[</span><span class="nx">runners</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span> <span class="p">=</span> <span class="s2">&#34;GitLab Runner 007&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url</span> <span class="p">=</span> <span class="s2">&#34;https://gitlab.com/&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">token</span> <span class="p">=</span> <span class="s2">&#34;******************&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">executor</span> <span class="p">=</span> <span class="s2">&#34;shell&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">shell</span> <span class="p">=</span> <span class="s2">&#34;powershell&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pre_clone_script</span> <span class="p">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">      chcp 65001
</span></span></span><span class="line"><span class="cl"><span class="s2">      $env:Path += &#34;</span><span class="err">;</span><span class="nx">C</span><span class="err">:\\</span><span class="nx">Gitlab</span><span class="err">\\</span><span class="nx">PortableGit</span><span class="err">\\</span><span class="nx">cmd</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">runners</span><span class="p">.</span><span class="nx">custom_build_dir</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">runners</span><span class="p">.</span><span class="nx">cache</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">runners</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">s3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">runners</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">gcs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">runners</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">azure</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you always see the Credential Helper Selector, please choose &ldquo;no helper&rdquo; and &ldquo;Always use this from now on&rdquo;.</p>
<p><a href="https://dennys.files.wordpress.com/2021/12/image-4.png"></a></p>
<h3 id="step-4---write-gitlab-ciyml">Step 4 - Write .gitlab-ci.yml</h3>
<ol>
<li>Edit .gitlab-ci.yml, the following is a sample:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">stages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">build</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;dotnet build&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">artifacts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">.\test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">script</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="s2">&#34;dotnet test&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-5---start-to-buildtestdeploy-code-local-machine">Step 5 - Start to build/test/deploy code (local machine)</h3>
<p>Change directory to the location of .gitlab-ci.yml and execute this command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gitlab-runner.exe <span class="nb">exec</span> shell build
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="step-6---start-to-test-cicd-local-machine">Step 6 - Start to test CI/CD (local machine)</h3>
<p>If everything is ok, you can commit .gitlab-ci.yml and GitLab should run it automatically.</p>
<h3 id="sast-static-application-security-testing">SAST (Static Application Security Testing)</h3>
<p>GitLab can check your source code for known vulnerabilities, unfortunately, it only support Linux container, Windows containers are not yet supported. (reference: <a href="https://docs.gitlab.com/ee/user/application_security/sast/" target="_blank" rel="noopener noreffer">https://docs.gitlab.com/ee/user/application_security/sast/</a>)</p>
]]></description>
</item>
<item>
    <title>GitLab Checkmarx integration</title>
    <link>https://dennys.github.io/en/doc/devops/gitlab-checkmarx-integration/</link>
    <pubDate>Sat, 15 Jan 2022 00:00:00 &#43;0800</pubDate>
    <author>Dennys</author>
    <guid>https://dennys.github.io/en/doc/devops/gitlab-checkmarx-integration/</guid>
    <description><![CDATA[<p>
</p>
<h2 id="purpose">Purpose</h2>
<p>When we commit code to <a href="https://gitlab.com/" target="_blank" rel="noopener noreffer">GitLab</a>, we want GitLab sends the code to <a href="https://checkmarx.com/" target="_blank" rel="noopener noreffer">Checkmarx</a> to scan. (the next step is to integrate the scan result to SonarQube)</p>
<h2 id="procedure">Procedure</h2>
<p>You can reference official document: <a href="https://checkmarx.atlassian.net/wiki/spaces/SD/pages/1929937052/GitLab&#43;Integration" target="_blank" rel="noopener noreffer">https://checkmarx.atlassian.net/wiki/spaces/SD/pages/1929937052/GitLab+Integration</a></p></p>
<ol>
<li>Edit .gitlab-ci.yml</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;https://raw.githubusercontent.com/checkmarx-ltd/cx-flow/develop/templates/gitlab/v3/Checkmarx.gitlab-ci.yml&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">variables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">CX_PROJECT</span><span class="p">:</span><span class="w"> </span><span class="l">ProjectXXX</span><span class="w"> </span><span class="c">#The project name you want to show in Checkmarx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Edit GitLab CI/CD variables</li>
</ol>
<p>Please remember to set <em><strong>GITLAB_URL</strong></em> and <em><strong>GITLAB_TOKEN</strong></em>, then Checkmarx will create GitLab issue for Checkmarx issues.</p>
<p><a href="https://dennys.files.wordpress.com/2022/01/image-4.png"></a></p>
<ol start="3">
<li>Trigger build - Checkmarx analysis will be triggered when you create a merge request or you commit to master stream directly.</li>
</ol>
<p>Suggest to use pure English for CX_TEAM, if you use non English (ex: Chinese), you can check the log and find it cannot find the team.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2022-01-12 02:51:22.748  INFO 11 --- [main] c.c.s.s.CxService [x4DNMhOL] : Found team /CxServer/Team1 with ID 16
</span></span></code></pre></td></tr></table>
</div>
</div><p>During the analysis, you can check the status from Checkmarx, it takes long time to analyze.</p>
<p><a href="https://dennys.files.wordpress.com/2022/01/image-6.png"></a></p>
<p>After the analysis, you can check the result in Checkmarx.</p>
<p>You can also check it from GitLab, it generates 1 report in merge request and it will create issues by category. The following is the reqport of merge request.</p>
<p><a href="https://dennys.files.wordpress.com/2022/01/image-7.png"></a></p>
<p>In the above report, there are 5 issues, it will creates 5 issues by file/by category.</p>
<p><a href="https://dennys.files.wordpress.com/2022/01/image-8.png"></a></p>
<p>In the issue, it shows the detail vulnerability information.</p>
<p><a href="https://dennys.files.wordpress.com/2022/01/image-9.png"></a></p>
]]></description>
</item>
<item>
    <title>GitLab Checkmarx SonarQube integration</title>
    <link>https://dennys.github.io/en/doc/devops/gitlab-checkmarx-sonarqube-integration/</link>
    <pubDate>Sat, 15 Jan 2022 00:00:00 &#43;0800</pubDate>
    <author>Dennys</author>
    <guid>https://dennys.github.io/en/doc/devops/gitlab-checkmarx-sonarqube-integration/</guid>
    <description><![CDATA[<p>

</p>
<h2 id="purpose">Purpose</h2>
<p>When we commit code to <a href="https://gitlab.com/" target="_blank" rel="noopener noreffer">GitLab</a>, we want GitLab to trigger these actions automatically:</p>
<ol>
<li><a href="https://gitlab.com/" target="_blank" rel="noopener noreffer">GitLab</a> sends the code to <a href="https://checkmarx.com/" target="_blank" rel="noopener noreffer">Checkmarx</a> to scan.</li>
<li><a href="https://gitlab.com/" target="_blank" rel="noopener noreffer">GitLab</a> triggers <a href="https://www.sonarqube.org/" target="_blank" rel="noopener noreffer">SonarQube</a> to sacn.</li>
<li><a href="https://www.sonarqube.org/" target="_blank" rel="noopener noreffer">SonarQube</a> integrate <a href="https://checkmarx.com/" target="_blank" rel="noopener noreffer">Checkmarx</a>&rsquo;s report.</li>
</ol>
<h2 id="procedure">Procedure</h2>
<p>You can reference the official document: <a href="https://checkmarx.atlassian.net/wiki/spaces/SD/pages/169246832/SonarQube&#43;Plugin&#43;v8.5.0&#43;and&#43;up" target="_blank" rel="noopener noreffer">https://checkmarx.atlassian.net/wiki/spaces/SD/pages/169246832/SonarQube+Plugin+v8.5.0+and+up</a></p>
<ol>
<li>Download the plugin from <a href="https://checkmarx.com/plugins/">here</a>, it only supports SonarQube LTS version (for now, it&rsquo;s 8.x)</li>
<li>Configurea Quality Gate/Profiles of SonarQube for Checkmarx&rsquo;s rules.</li>
<li>Use GitLab to trigger Checkmarx scan and record the project name of Checkmarx.</li>
<li>Configure Checkmarx data in SonarQube, you can reference <a href="https://checkmarx.atlassian.net/wiki/spaces/SD/pages/169345207/Configuring+a+Project+for+the+Checkmarx+SonarQube+Plugin+v8.5.0+and+up">here</a>.</li>
<li>Trigger GitLab CI again, you will see the following log in your SonarQube job</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">INFO: Sensor Import Checkmarx scan results to SonarQube <span class="o">[</span>checkmarx<span class="o">]</span>
</span></span><span class="line"><span class="cl">INFO: Retrieving Checkmarx scan results <span class="k">for</span> current module <span class="o">[</span>Checkmarx plugin version: 2021.2.1<span class="o">]</span>
</span></span><span class="line"><span class="cl">INFO: Getting Checkmarx configuration data from sonar Database.
</span></span><span class="line"><span class="cl">INFO: Resolving Cx setting: checkmarx.server.project_name
</span></span><span class="line"><span class="cl">INFO: Forced authentication is enabled: Sonar credentials must be provided
</span></span><span class="line"><span class="cl">INFO: Sonar server token is provided
</span></span><span class="line"><span class="cl">INFO: Checkmarx credentials migration not needed
</span></span><span class="line"><span class="cl">INFO: Sonar server token is provided
</span></span><span class="line"><span class="cl">INFO: Resolving Cx setting: checkmarx.server.project_name
</span></span><span class="line"><span class="cl">INFO: Forced authentication is enabled: Sonar credentials must be provided
</span></span><span class="line"><span class="cl">INFO: Checkmarx server version <span class="o">[</span>9.2.0.41015<span class="o">]</span>. Hotfix <span class="o">[</span>24<span class="o">]</span>.
</span></span><span class="line"><span class="cl">INFO: Logging into the Checkmarx service.
</span></span><span class="line"><span class="cl">INFO: Connecting to https://your.checkmarx.server/
</span></span><span class="line"><span class="cl">INFO: Initializing Cx client <span class="o">[</span>2020.2.4.NO.SCA<span class="o">]</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx server version <span class="o">[</span>9.2.0.41015<span class="o">]</span>. Hotfix <span class="o">[</span>24<span class="o">]</span>.
</span></span><span class="line"><span class="cl">INFO: Logging into the Checkmarx service.
</span></span><span class="line"><span class="cl">INFO: full team path: <span class="se">\C</span>xServer<span class="se">\\</span>Team1
</span></span><span class="line"><span class="cl">INFO: preset name: All
</span></span><span class="line"><span class="cl">INFO: ---------------------------------Get Last CxSAST Results:--------------------------------
</span></span><span class="line"><span class="cl">INFO: Waiting <span class="k">for</span> server to generate xml report. <span class="m">4990</span> seconds left to timeout
</span></span><span class="line"><span class="cl">INFO: Checkmarx High vulnerabilities: <span class="m">3</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx New-High vulnerabilities: <span class="m">0</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx Medium vulnerabilities: <span class="m">23</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx New-Medium vulnerabilities: <span class="m">1</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx Low vulnerabilities: <span class="m">142</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx New-Low vulnerabilities: <span class="m">7</span>
</span></span><span class="line"><span class="cl">INFO: Checkmarx scan link: https://your.checkmarx.server//CxWebClient/ViewerMain.aspx?scanId<span class="o">=</span>1000157<span class="p">&amp;</span><span class="nv">ProjectID</span><span class="o">=</span><span class="m">67</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>You can see the Checkmarx issues in SonarQube now.</li>
</ol>
]]></description>
</item>
</channel>
</rss>
